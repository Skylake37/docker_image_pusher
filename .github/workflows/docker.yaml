name: Docker Image Sync to Aliyun

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
  WEBHOOK_URL: "${{ secrets.WEBHOOK_URL }}" # åœ¨ Secrets ä¸­é…ç½®é£ä¹¦æˆ–ä¼å¾®åœ°å€

jobs:
  build:
    name: Sync Images
    runs-on: ubuntu-latest
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          overprovision-lvm: 'true'
          build-mount-path: '/var/lib/docker/'
    
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Restart docker
        run: |
          # æ¸…ç† Docker æ„å»ºç¼“å­˜ï¼ˆå¦‚æœä¹‹å‰æ²¡åšï¼‰
          docker builder prune -f
          # æ¸…ç† Runner æ—¥å¿—ï¼ˆä¸å½±å“è¿è¡Œä¸­çš„ä»»åŠ¡ï¼‰
          sudo rm -rf /home/runner/actions-runner/_diag/*
          sudo service docker restart
          
      - name: Install regctl
        run: |
          curl -L https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 > regctl
          chmod +x regctl
          sudo mv regctl /usr/local/bin/
        
      - name: Sync and Push to Aliyun
        id: sync_step
        run: |
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login -u "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"
          
          SYNC_SUMMARY=""
          SUCCESS_COUNT=0
          FAILURE_COUNT=0

          while IFS= read -r line || [ -n "$line" ]; do
              [[ -z "$line" ]] || [[ "$line" =~ ^\s*# ]] && continue
          
              # ---------- ä½¿ç”¨ eval å°†å¸¦å¼•å·çš„è¡Œè§£æä¸ºæ•°ç»„ ----------
              # è­¦å‘Šï¼šç¡®ä¿ images.txt å†…å®¹å¯ä¿¡ï¼Œé¿å…æ³¨å…¥é£é™©
              eval "parts=($line)"
              # ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯é•œåƒå
              full_image="${parts[0]}"
              # å‰©ä½™å…ƒç´ éƒ½æ˜¯å‚æ•°
              pull_params=("${parts[@]:1}")
          
              # ---------- æå–é•œåƒåæ ‡ç­¾å’Œä»“åº“ç»„ç»‡ï¼ˆåŸé€»è¾‘ä¸å˜ï¼‰ ----------
              image_name_tag=$(echo "$full_image" | awk -F'/' '{print $NF}')
              if [[ "$full_image" == *"/"* ]]; then
                  org_part=$(echo "$full_image" | sed "s|\/${image_name_tag}||" | tr '/' '_')
              else
                  org_part="library"
              fi
              new_repo_name="${org_part}_${image_name_tag}"
              target_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$new_repo_name"
          
              # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼ˆåŸæœ‰é€»è¾‘ï¼Œç”¨äºè·³è¿‡å·²å­˜åœ¨çš„æ­£å¸¸é•œåƒï¼‰
              if skopeo inspect docker://$target_image --creds "$ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD" > /dev/null 2>&1; then
                  echo ">>> Skip: $image_name_tag"
                  continue
              fi
              
              # æ‰§è¡Œæ‹‰å–ï¼ˆå¸¦å‚æ•°ï¼‰
              echo "Pulling $full_image with params: ${pull_params[*]}"
              if [ ${#pull_params[@]} -eq 0 ]; then
                  docker pull "$full_image"
              else
                  docker pull "${pull_params[@]}" "$full_image"
              fi
          
              # å¦‚æœæ‹‰å–å¤±è´¥ï¼Œè®°å½•å¹¶è·³è¿‡åç»­
              if [ $? -ne 0 ]; then
                  echo "Pull failed for $full_image"
                  SYNC_SUMMARY="${SYNC_SUMMARY}\nğŸš¨ ${image_name_tag} (æ‹‰å–å¤±è´¥)"
                  FAILURE_COUNT=$((FAILURE_COUNT + 1))
                  continue
              fi
          
              # ---------- æ‰“æ ‡ç­¾ã€æ¨é€ã€æ¸…ç†ï¼ˆåŸé€»è¾‘ï¼‰ ----------
              if docker tag "$full_image" "$target_image" && docker push "$target_image"; then
                  docker rmi "$full_image" "$target_image"
                  SYNC_SUMMARY="${SYNC_SUMMARY}\nâœ¨ ${image_name_tag}"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                  SYNC_SUMMARY="${SYNC_SUMMARY}\nğŸš¨ ${image_name_tag} (æ¨é€å¤±è´¥)"
                  FAILURE_COUNT=$((FAILURE_COUNT + 1))
              fi
          done < images.txt

          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "FAILURE_COUNT=$FAILURE_COUNT" >> $GITHUB_ENV
          {
            echo 'SYNC_RESULT<<EOF'
            echo -e "$SYNC_SUMMARY"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: å‘é€ Webhook é€šçŸ¥
        if: always()
        run: |
          if [ -z "${{ secrets.WEBHOOK_URL }}" ]; then exit 0; fi

          S_COUNT=${{ env.SUCCESS_COUNT }}
          F_COUNT=${{ env.FAILURE_COUNT }}

          # 1. åˆ¤å®šæ ‡é¢˜å’Œä¸»çŠ¶æ€
          if [ "$F_COUNT" -gt 0 ]; then
              TITLE="âŒ é˜¿é‡Œäº‘é•œåƒåŒæ­¥å¤±è´¥"
              CONTENT="âš ï¸ è­¦å‘Šï¼šæœ‰ $F_COUNT ä¸ªé•œåƒåŒæ­¥å‡ºç°å¼‚å¸¸ï¼Œè¯·åŠæ—¶æ£€æŸ¥ã€‚"
          elif [ "$S_COUNT" -gt 0 ]; then
              TITLE="âœ… é˜¿é‡Œäº‘é•œåƒåŒæ­¥æˆåŠŸ"
              CONTENT="æœ¬æ¬¡æ–°å¢åŒæ­¥é•œåƒå¦‚ä¸‹ï¼š"
          else
            # å¦‚æœå…¨æ˜¯è·³è¿‡ï¼Œä¸ºäº†ä¸éªšæ‰°ï¼Œå¯ä»¥é€‰æ‹©ä¸å‘ï¼Œæˆ–è€…å‘ä¸€æ¡ç®€æ´çš„
            TITLE="â˜• åŒæ­¥ä»»åŠ¡å®Œæˆ (æ— æ–°é•œåƒ)"
            CONTENT="æ£€æµ‹åˆ° images.txt ä¸­æš‚æ— æ–°é•œåƒéœ€è¦åŒæ­¥ã€‚"
          fi

          # 2. ç»„è£…æœ€ç»ˆæ–‡æœ¬ (ç§»é™¤è·³è¿‡çš„åˆ—è¡¨ï¼Œåªæ˜¾ç¤º SYNC_RESULT)
          RAW_TEXT=$(cat <<EOF
          $TITLE
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          $CONTENT
          ${{ env.SYNC_RESULT }}

          ğŸ“Š ç»Ÿè®¡: æˆåŠŸ $S_COUNT | å¤±è´¥ $F_COUNT
          ğŸ”— è¯¦æƒ…: [æŸ¥çœ‹ GitHub Action æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )

          # 3. å‘é€
          JSON_PAYLOAD=$(jq -n --arg msg "$RAW_TEXT" '{"msg_type":"text","content":{"text":$msg}}')
          curl -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "${{ secrets.WEBHOOK_URL }}"
